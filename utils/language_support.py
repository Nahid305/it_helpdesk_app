"""
Multi-Language Support for IT Helpdesk
Provides language detection, translation, and localized responses
"""

import streamlit as st
import json
import os
from typing import Dict, Any, Optional

class LanguageSupport:
    """Handles multi-language support for the IT Helpdesk"""
    
    def __init__(self):
        self.supported_languages = {
            'en': {'name': 'English', 'flag': 'üá∫üá∏'},
            'es': {'name': 'Espa√±ol', 'flag': 'üá™üá∏'},
            'fr': {'name': 'Fran√ßais', 'flag': 'üá´üá∑'},
            'de': {'name': 'Deutsch', 'flag': 'üá©üá™'},
            'it': {'name': 'Italiano', 'flag': 'üáÆüáπ'},
            'pt': {'name': 'Portugu√™s', 'flag': 'üáµüáπ'},
            'nl': {'name': 'Nederlands', 'flag': 'üá≥üá±'},
            'ru': {'name': '–†—É—Å—Å–∫–∏–π', 'flag': 'üá∑üá∫'},
            'zh': {'name': '‰∏≠Êñá', 'flag': 'üá®üá≥'},
            'ja': {'name': 'Êó•Êú¨Ë™û', 'flag': 'üáØüáµ'},
            'ko': {'name': 'ÌïúÍµ≠Ïñ¥', 'flag': 'üá∞üá∑'},
            'ar': {'name': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', 'flag': 'üá∏üá¶'},
            'hi': {'name': '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', 'flag': 'üáÆüá≥'}
        }
        self.load_translations()
    
    def load_translations(self):
        """Load translation dictionary for common IT terms and responses"""
        self.translations = {
            'en': {
                'welcome': "Hello! I'm your AI-powered IT Helpdesk assistant. How can I help you today?",
                'ask_question': "Ask your IT question:",
                'send': "Send",
                'helpful': "Helpful",
                'not_helpful': "Not Helpful", 
                'create_ticket': "Create Ticket",
                'new_chat': "Start New Chat",
                'end_chat': "End Chat",
                'clear_chat': "Clear Chat",
                'thank_you': "Thank you for using our IT Support! üòä",
                'new_session': "Starting a new chat session for you...",
                'ticket_question': "Would you like to create a ticket for a human to assist you?",
                'no_thanks': "No, thanks",
                'start_new_chat': "Start New Chat",
                'login_required': "You must be logged in to use the chat assistant.",
                'basic_mode': "‚ö° **Basic Mode**: AI service unavailable, using rule-based responses. Check your API configuration in .env file.",
                'enter_message': "Please enter a message before sending.",
                'starting_new_chat': "Starting a new chat session for you...",
                'language_select': "Select Language:",
                'password_reset': "Password Reset",
                'vpn_issues': "VPN Issues",
                'email_problems': "Email Problems",
                'printer_setup': "Printer Setup",
                'network_issues': "Network Issues",
                'software_help': "Software Help"
            },
            'es': {
                'welcome': "¬°Hola! Soy tu asistente de mesa de ayuda IT con IA. ¬øC√≥mo puedo ayudarte hoy?",
                'ask_question': "Haz tu pregunta de IT:",
                'send': "Enviar",
                'helpful': "√ötil",
                'not_helpful': "No √ötil",
                'create_ticket': "Crear Ticket",
                'new_chat': "Nuevo Chat",
                'end_chat': "Terminar Chat",
                'clear_chat': "Limpiar Chat",
                'thank_you': "¬°Gracias por usar nuestro soporte IT! üòä",
                'new_session': "Iniciando una nueva sesi√≥n de chat para ti...",
                'ticket_question': "¬øTe gustar√≠a crear un ticket para que un humano te asista?",
                'no_thanks': "No, gracias",
                'start_new_chat': "Iniciar Nuevo Chat",
                'login_required': "Debes iniciar sesi√≥n para usar el asistente de chat.",
                'basic_mode': "‚ö° **Modo B√°sico**: Servicio de IA no disponible, usando respuestas basadas en reglas. Verifica tu configuraci√≥n de API en el archivo .env.",
                'enter_message': "Por favor ingresa un mensaje antes de enviar.",
                'starting_new_chat': "Iniciando una nueva sesi√≥n de chat para ti...",
                'language_select': "Seleccionar Idioma:",
                'password_reset': "Restablecer Contrase√±a",
                'vpn_issues': "Problemas de VPN",
                'email_problems': "Problemas de Email",
                'printer_setup': "Configurar Impresora",
                'network_issues': "Problemas de Red",
                'software_help': "Ayuda de Software"
            },
            'fr': {
                'welcome': "Bonjour! Je suis votre assistant de support IT aliment√© par IA. Comment puis-je vous aider aujourd'hui?",
                'ask_question': "Posez votre question IT:",
                'send': "Envoyer",
                'helpful': "Utile",
                'not_helpful': "Pas Utile",
                'create_ticket': "Cr√©er Ticket",
                'new_chat': "Nouveau Chat",
                'end_chat': "Terminer Chat",
                'clear_chat': "Effacer Chat",
                'thank_you': "Merci d'utiliser notre support IT! üòä",
                'new_session': "D√©marrage d'une nouvelle session de chat pour vous...",
                'ticket_question': "Souhaitez-vous cr√©er un ticket pour qu'un humain vous assiste?",
                'no_thanks': "Non, merci",
                'start_new_chat': "D√©marrer Nouveau Chat",
                'login_required': "Vous devez √™tre connect√© pour utiliser l'assistant de chat.",
                'basic_mode': "‚ö° **Mode Basique**: Service IA indisponible, utilisant des r√©ponses bas√©es sur des r√®gles. V√©rifiez votre configuration API dans le fichier .env.",
                'enter_message': "Veuillez saisir un message avant d'envoyer.",
                'starting_new_chat': "D√©marrage d'une nouvelle session de chat pour vous...",
                'language_select': "S√©lectionner la Langue:",
                'password_reset': "R√©initialiser Mot de Passe",
                'vpn_issues': "Probl√®mes VPN",
                'email_problems': "Probl√®mes Email",
                'printer_setup': "Configuration Imprimante",
                'network_issues': "Probl√®mes R√©seau",
                'software_help': "Aide Logiciel"
            },
            'de': {
                'welcome': "Hallo! Ich bin Ihr KI-gest√ºtzter IT-Helpdesk-Assistent. Wie kann ich Ihnen heute helfen?",
                'ask_question': "Stellen Sie Ihre IT-Frage:",
                'send': "Senden",
                'helpful': "Hilfreich",
                'not_helpful': "Nicht Hilfreich",
                'create_ticket': "Ticket Erstellen",
                'new_chat': "Neuer Chat",
                'end_chat': "Chat Beenden",
                'clear_chat': "Chat L√∂schen",
                'thank_you': "Vielen Dank f√ºr die Nutzung unseres IT-Supports!",
                'starting_new_chat': "Starte eine neue Chat-Sitzung f√ºr Sie...",
                'language_select': "Sprache Ausw√§hlen:",
                'password_reset': "Passwort Zur√ºcksetzen",
                'vpn_issues': "VPN-Probleme",
                'email_problems': "E-Mail-Probleme",
                'printer_setup': "Drucker Einrichten",
                'network_issues': "Netzwerkprobleme",
                'software_help': "Software-Hilfe"
            },
            'zh': {
                'welcome': "ÊÇ®Â•ΩÔºÅÊàëÊòØÊÇ®ÁöÑAIÈ©±Âä®ÁöÑITÂ∏ÆÂä©Âè∞Âä©Êâã„ÄÇ‰ªäÂ§©ÊàëÂèØ‰ª•‰∏∫ÊÇ®ÂÅö‰∫õ‰ªÄ‰πàÔºü",
                'ask_question': "ËØ∑ÊèêÂá∫ÊÇ®ÁöÑITÈóÆÈ¢òÔºö",
                'send': "ÂèëÈÄÅ",
                'helpful': "ÊúâÂ∏ÆÂä©",
                'not_helpful': "Ê≤°Â∏ÆÂä©",
                'create_ticket': "ÂàõÂª∫Â∑•Âçï",
                'new_chat': "Êñ∞ÂØπËØù",
                'end_chat': "ÁªìÊùüÂØπËØù",
                'clear_chat': "Ê∏ÖÈô§ÂØπËØù",
                'thank_you': "ÊÑüË∞¢ÊÇ®‰ΩøÁî®Êàë‰ª¨ÁöÑITÊîØÊåÅÔºÅ",
                'starting_new_chat': "Ê≠£Âú®‰∏∫ÊÇ®ÂºÄÂßãÊñ∞ÁöÑËÅäÂ§©‰ºöËØù...",
                'language_select': "ÈÄâÊã©ËØ≠Ë®ÄÔºö",
                'password_reset': "ÂØÜÁ†ÅÈáçÁΩÆ",
                'vpn_issues': "VPNÈóÆÈ¢ò",
                'email_problems': "ÈÇÆÁÆ±ÈóÆÈ¢ò",
                'printer_setup': "ÊâìÂç∞Êú∫ËÆæÁΩÆ",
                'network_issues': "ÁΩëÁªúÈóÆÈ¢ò",
                'software_help': "ËΩØ‰ª∂Â∏ÆÂä©"
            }
        }
    
    def get_supported_languages(self) -> Dict[str, Dict[str, str]]:
        """Get list of supported languages"""
        return self.supported_languages
    
    def get_text(self, key: str, language: str = 'en') -> str:
        """Get translated text for a given key and language"""
        if language not in self.translations:
            language = 'en'  # Fallback to English
        
        return self.translations[language].get(key, self.translations['en'].get(key, key))
    
    def detect_language(self, text: str) -> str:
        """Simple language detection based on common words and patterns"""
        text_lower = text.lower()
        
        # Simple keyword-based detection with scoring
        language_indicators = {
            'it': ['ciao', 'grazie', 'per favore', 'aiuto', 'problema', 'password', 'italiano', 'ho', 'bisogno', 'pu√≤', 'salve', 'buongiorno'],
            'es': ['hola', 'gracias', 'por favor', 'ayuda', 'problema', 'contrase√±a', 'espa√±ol', 'tengo', 'necesito', 'puede', 'buenos d√≠as', 'quiero', 'instalar', 'como', 'donde', 'que', 'soy', 'estoy', 'mi', 'tu', 'su', 'este', 'esta'],
            'fr': ['bonjour', 'merci', 's\'il vous pla√Æt', 'aide', 'probl√®me', 'mot de passe', 'fran√ßais', 'j\'ai', 'besoin', 'pouvez', 'salut'],
            'de': ['hallo', 'danke', 'bitte', 'hilfe', 'problem', 'passwort', 'deutsch', 'ich habe', 'brauche', 'k√∂nnen', 'guten tag'],
            'pt': ['ol√°', 'obrigado', 'por favor', 'ajuda', 'problema', 'senha', 'portugu√™s', 'tenho', 'preciso', 'pode', 'bom dia'],
            'nl': ['hallo', 'dank je', 'alsjeblieft', 'hulp', 'probleem', 'wachtwoord', 'nederlands', 'ik heb', 'nodig', 'kunt', 'goedemorgen'],
            'zh': ['‰Ω†Â•Ω', 'Ë∞¢Ë∞¢', 'ËØ∑', 'Â∏ÆÂä©', 'ÈóÆÈ¢ò', 'ÂØÜÁ†Å', '‰∏≠Êñá', 'ÊàëÊúâ', 'ÈúÄË¶Å', 'ÂèØ‰ª•'],
            'ja': ['„Åì„Çì„Å´„Å°„ÅØ', '„ÅÇ„Çä„Åå„Å®„ÅÜ', '„ÅäÈ°ò„ÅÑ', '„Éò„É´„Éó', 'ÂïèÈ°å', '„Éë„Çπ„ÉØ„Éº„Éâ', 'Êó•Êú¨Ë™û', 'ÁßÅ„ÅØ', 'ÂøÖË¶Å', '„Åß„Åç„Åæ„Åô'],
            'ko': ['ÏïàÎÖïÌïòÏÑ∏Ïöî', 'Í∞êÏÇ¨Ìï©ÎãàÎã§', 'Ï†úÎ∞ú', 'ÎèÑÏõÄ', 'Î¨∏Ï†ú', 'ÎπÑÎ∞ÄÎ≤àÌò∏', 'ÌïúÍµ≠Ïñ¥', 'Ï†ÄÎäî', 'ÌïÑÏöî', 'Ìï† Ïàò'],
            'ar': ['ŸÖÿ±ÿ≠ÿ®ÿß', 'ÿ¥ŸÉÿ±ÿß', 'ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ', 'ŸÖÿ≥ÿßÿπÿØÿ©', 'ŸÖÿ¥ŸÉŸÑÿ©', 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±', 'ÿπÿ±ÿ®Ÿä', 'ŸÑÿØŸä', 'ÿ£ÿ≠ÿ™ÿßÿ¨', 'ŸäŸÖŸÉŸÜ'],
            'ru': ['–ø—Ä–∏–≤–µ—Ç', '—Å–ø–∞—Å–∏–±–æ', '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞', '–ø–æ–º–æ—â—å', '–ø—Ä–æ–±–ª–µ–º–∞', '–ø–∞—Ä–æ–ª—å', '—Ä—É—Å—Å–∫–∏–π', '—É –º–µ–Ω—è', '–Ω—É–∂–Ω–æ', '–º–æ–∂–µ—Ç–µ'],
            'hi': ['‡§®‡§Æ‡§∏‡•ç‡§§‡•á', '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶', '‡§ï‡•É‡§™‡§Ø‡§æ', '‡§Æ‡§¶‡§¶', '‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°', '‡§π‡§ø‡§Ç‡§¶‡•Ä', '‡§Æ‡•á‡§∞‡•á ‡§™‡§æ‡§∏', '‡§ö‡§æ‡§π‡§ø‡§è', '‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á']
        }
        
        # Score each language based on keyword matches
        language_scores = {}
        for lang, keywords in language_indicators.items():
            score = sum(1 for keyword in keywords if keyword in text_lower)
            if score > 0:
                language_scores[lang] = score
        
        # Return the language with the highest score
        if language_scores:
            return max(language_scores.items(), key=lambda x: x[1])[0]
        
        return 'en'  # Default to English
    
    def format_multilingual_response(self, response: str, user_language: str) -> str:
        """Format response with language-appropriate styling"""
        if user_language == 'ar':
            # Right-to-left for Arabic
            return f'<div dir="rtl" style="text-align: right;">{response}</div>'
        elif user_language in ['zh', 'ja', 'ko']:
            # Special formatting for CJK languages
            return f'<div style="line-height: 1.6;">{response}</div>'
        else:
            return response
    
    def get_language_prompt(self, user_language: str) -> str:
        """Get language-specific prompt for AI responses"""
        prompts = {
            'es': "IMPORTANTE: Responde SIEMPRE en espa√±ol. Eres un asistente de soporte t√©cnico IT. Traduce toda tu respuesta al espa√±ol, incluyendo t√≠tulos, pasos y notas. Usa t√©rminos t√©cnicos en espa√±ol cuando sea posible.",
            'fr': "IMPORTANT: R√©pondez TOUJOURS en fran√ßais. Vous √™tes un assistant de support technique IT. Traduisez toute votre r√©ponse en fran√ßais.",
            'de': "WICHTIG: Antworte IMMER auf Deutsch. Du bist ein IT-Support-Assistent. √úbersetze deine gesamte Antwort ins Deutsche.",
            'zh': "ÈáçË¶ÅÔºöÂßãÁªàÁî®‰∏≠ÊñáÂõûÁ≠î„ÄÇ‰Ω†ÊòØ‰∏Ä‰∏™ITÊäÄÊúØÊîØÊåÅÂä©Êâã„ÄÇÂ∞Ü‰Ω†ÁöÑÊï¥‰∏™ÂõûÁ≠îÁøªËØëÊàê‰∏≠Êñá„ÄÇ",
            'ja': "ÈáçË¶ÅÔºöÂøÖ„ÅöÊó•Êú¨Ë™û„ÅßÁ≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„ÅÇ„Å™„Åü„ÅØIT„Çµ„Éù„Éº„Éà„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÂõûÁ≠îÂÖ®‰Ωì„ÇíÊó•Êú¨Ë™û„Å´ÁøªË®≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            'ar': "ŸÖŸáŸÖ: ÿ£ÿ¨ÿ® ÿØÿßÿ¶ŸÖÿßŸã ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©. ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ÿØÿπŸÖ ÿ™ŸÇŸÜŸä IT. ÿ™ÿ±ÿ¨ŸÖ ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ŸÉÿßŸÖŸÑÿ© ÿ•ŸÑŸâ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©.",
            'ru': "–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ IT-–ø–æ–¥–¥–µ—Ä–∂–∫–∏. –ü–µ—Ä–µ–≤–æ–¥–∏ –≤–µ—Å—å —Å–≤–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.",
            'hi': "‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£: ‡§π‡§Æ‡•á‡§∂‡§æ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§ ‡§Ü‡§™ ‡§è‡§ï IT ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§Ç‡§ü ‡§π‡•à‡§Ç‡•§ ‡§Ö‡§™‡§®‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶ ‡§ï‡§∞‡•á‡§Ç‡•§",
            'pt': "IMPORTANTE: Responda SEMPRE em portugu√™s. Voc√™ √© um assistente de suporte t√©cnico IT. Traduza toda sua resposta para o portugu√™s.",
            'it': "IMPORTANTE: Rispondi SEMPRE in italiano. Sei un assistente di supporto tecnico IT. Traduci tutta la tua risposta in italiano.",
            'nl': "BELANGRIJK: Antwoord ALTIJD in het Nederlands. Je bent een IT-ondersteuningsassistent. Vertaal je hele antwoord naar het Nederlands.",
            'ko': "Ï§ëÏöî: Ìï≠ÏÉÅ ÌïúÍµ≠Ïñ¥Î°ú ÎãµÌïòÏÑ∏Ïöî. ÎãπÏã†ÏùÄ IT ÏßÄÏõê ÎèÑÏö∞ÎØ∏ÏûÖÎãàÎã§. Ï†ÑÏ≤¥ ÎãµÎ≥ÄÏùÑ ÌïúÍµ≠Ïñ¥Î°ú Î≤àÏó≠ÌïòÏÑ∏Ïöî."
        }
        
        return prompts.get(user_language, "Respond in English. You are an IT support assistant.")
    
    def format_response(self, response: str, user_language: str) -> str:
        """Format a basic response in the user's language using simple translation patterns"""
        if user_language == 'en':
            return response
            
        # Simple keyword translation for basic responses
        translations = {
            'es': {
                'Hi': 'Hola', 'Hello': 'Hola', 'Step': 'Paso', 'Click': 'Haz clic',
                'Go to': 'Ve a', 'Enter': 'Ingresa', 'Check': 'Verifica',
                'That should get you back': 'Eso deber√≠a devolverle el acceso',
                'If you don\'t receive': 'Si no recibes', 'minutes': 'minutos',
                'check your spam folder': 'revisa tu carpeta de spam'
            },
            'fr': {
                'Hi': 'Salut', 'Hello': 'Bonjour', 'Step': '√âtape', 'Click': 'Cliquez',
                'Go to': 'Allez √†', 'Enter': 'Entrez', 'Check': 'V√©rifiez',
                'That should get you back': 'Cela devrait vous reconnecter',
                'If you don\'t receive': 'Si vous ne recevez pas', 'minutes': 'minutes',
                'check your spam folder': 'v√©rifiez votre dossier spam'
            }
            # Add more languages as needed
        }
        
        if user_language in translations:
            translated_response = response
            for english, translation in translations[user_language].items():
                translated_response = translated_response.replace(english, translation)
            return translated_response
        
        return response  # Return original if no translation available
    
    def get_welcome_message(self, username: str, is_grok_available: bool, language: str = None) -> str:
        """Generate a welcome message in the specified language"""
        if language is None:
            language = 'en'  # Default to English
        
        # Get base welcome text
        welcome_text = self.get_text('welcome', language)
        
        # Replace placeholder with username
        if language == 'en':
            welcome_text = welcome_text.replace("Hello!", f"Hello {username}!")
        else:
            # For other languages, just add username at appropriate place
            welcome_text = welcome_text.replace("Hello!", f"{username}!")
        
        # Add capability message based on Grok availability
        if is_grok_available:
            if language == 'en':
                welcome_text += " I can help you with a wide range of IT issues. What can I help you with today?"
            elif language == 'es':
                welcome_text += " Puedo ayudarte con una amplia gama de problemas de IT. ¬øEn qu√© puedo ayudarte hoy?"
            elif language == 'fr':
                welcome_text += " Je peux vous aider avec une large gamme de probl√®mes IT. Comment puis-je vous aider aujourd'hui?"
            else:
                welcome_text += " I can help you with a wide range of IT issues. What can I help you with today?"
        else:
            if language == 'en':
                welcome_text += " I'm in basic mode but can still help with common issues. How can I assist you?"
            elif language == 'es':
                welcome_text += " Estoy en modo b√°sico pero a√∫n puedo ayudar con problemas comunes. ¬øC√≥mo puedo asistirte?"
            elif language == 'fr':
                welcome_text += " Je suis en mode de base mais je peux encore aider avec des probl√®mes courants. Comment puis-je vous aider?"
            else:
                welcome_text += " I'm in basic mode but can still help with common issues. How can I assist you?"
        
        return welcome_text

# Global language support instance
language_support = LanguageSupport()
